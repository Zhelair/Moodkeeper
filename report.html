<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Moodkeeper Report</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:900px}
    h1{margin:0 0 8px}
    .muted{color:#555}
    .card{border:1px solid #ddd;border-radius:12px;padding:14px;margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .kv{display:flex;justify-content:space-between;gap:14px;border-bottom:1px solid #eee;padding:6px 0}
    .kv:last-child{border-bottom:none}
    .tag{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:4px 10px;margin:2px 6px 0 0;font-size:12px}
    @media print {.noprint{display:none}}
  </style>
</head>
<body>
  <div class="noprint">
    <button onclick="window.print()">Print / Save as PDF</button>
  </div>
  <h1>Moodkeeper Report</h1>
  <div class="muted">Generated locally in your browser. No data is uploaded.</div>

  <div id="content" class="card">Loading…</div>

  <script>
    (function(){
      function openDB(){
        return new Promise((resolve, reject)=>{
          const req = indexedDB.open('trackboard', 1);
          req.onsuccess = ()=>resolve(req.result);
          req.onerror = ()=>reject(req.error);
        });
      }
      async function getAllEntries(){
        const db = await openDB();
        return new Promise((res, rej)=>{
          const tx = db.transaction('entries','readonly');
          const store = tx.objectStore('entries');
          const r = store.getAll();
          r.onsuccess = ()=>res(r.result||[]);
          r.onerror = ()=>rej(r.error);
        });
      }
      function fmt(d){ return new Date(d+'T00:00:00').toLocaleDateString(undefined,{weekday:'short',year:'numeric',month:'short',day:'numeric'}); }
      (async ()=>{
        const entries = (await getAllEntries()).sort((a,b)=>a.date.localeCompare(b.date));
        const el = document.getElementById('content');
        if(!entries.length){
          el.textContent = 'No entries yet.';
          return;
        }
        let html = '';
        for(const e of entries.slice(-14)){ // last 14 days
          html += '<div class="card">';
          html += '<div class="kv"><div><strong>'+fmt(e.date)+'</strong></div><div>Mood: '+(e.mood||'—')+'</div></div>';
          if(e.tags && e.tags.length){
            html += '<div style="margin-top:8px">';
            for(const t of e.tags){ html += '<span class="tag">'+t+'</span>'; }
            html += '</div>';
          }
          if(e.good){ html += '<div style="margin-top:8px"><strong>Something good:</strong> '+escapeHtml(e.good)+'</div>'; }
          if(e.note){ html += '<div style="margin-top:8px"><strong>Notes:</strong> '+escapeHtml(e.note)+'</div>'; }
          if(e.alcohol){ html += '<div style="margin-top:8px"><strong>Alcohol:</strong> '+escapeHtml(e.alcohol)+'</div>'; }
          if(e.sleepBed || e.sleepWake){
            html += '<div style="margin-top:8px"><strong>Sleep:</strong> '+(e.sleepBed||'—')+' → '+(e.sleepWake||'—')+(e.sleepPoor?' (poor)':'')+'</div>';
          }
          html += '</div>';
        }
        el.innerHTML = html;
      })();

      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
      }
    })();
  </script>
</body>
</html>
